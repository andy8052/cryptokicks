<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head style="width:100%; height:100%;">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Facebook and Twitter integration -->
    <meta property="og:title" content="" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="" />
    <meta property="og:description" content="" />
    <meta name="twitter:title" content="" />
    <meta name="twitter:image" content="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:card" content="" />

    <script src="https://www.gstatic.com/firebasejs/4.8.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCMFwcKtpVJQJFKZAOTl-PbMZtarCCOdWI",
            authDomain: "cryptokicks8052.firebaseapp.com",
            databaseURL: "https://cryptokicks8052.firebaseio.com",
            projectId: "cryptokicks8052",
            storageBucket: "cryptokicks8052.appspot.com",
            messagingSenderId: "578246028086"
        };
        firebase.initializeApp(config);

    </script>

    <script src="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.css" />
    <script type="text/javascript">
        // FirebaseUI config.
        var uiConfig = {
            signInFlow: 'popup',
            signInSuccessUrl: 'index.html',
            signInOptions: [
                // Leave the lines as is for the providers you want to offer your users.
                firebase.auth.GoogleAuthProvider.PROVIDER_ID
                //firebase.auth.FacebookAuthProvider.PROVIDER_ID,
                //firebase.auth.TwitterAuthProvider.PROVIDER_ID,
                //firebase.auth.GithubAuthProvider.PROVIDER_ID,
                //                firebase.auth.EmailAuthProvider.PROVIDER_ID
                //firebase.auth.PhoneAuthProvider.PROVIDER_ID
            ]
        };

        // Initialize the FirebaseUI Widget using Firebase.
        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        // The start method will wait until the DOM is loaded.
        ui.start('#firebaseui-auth-container', uiConfig);

    </script>


    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="shortcut icon" href="favicon.ico">
    <!-- Google Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Playfair+Display:400,700,400italic|Roboto:400,300,700' rel='stylesheet' type='text/css'>
    <!-- Animate -->
    <link rel="stylesheet" href="css/animate.css">
    <!-- Icomoon -->
    <link rel="stylesheet" href="css/icomoon.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="css/bootstrap.css">

    <link rel="stylesheet" href="css/style.css">


    <!-- Modernizr JS -->
    <script src="js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
	<script src="js/respond.min.js"></script>
	<![endif]-->

</head>

<body style="width:100%; height:100%;">
    <div id="fh5co-offcanvas">
        <a href="#" class="fh5co-close-offcanvas js-fh5co-close-offcanvas"><span><i class="icon-cross3"></i> <span>Close</span></span></a>
        <h1 id="username" align="center"></h1>
        <div id="firebaseui-auth-container"></div>

        <div class="fh5co-bio">
            <button id="listingButton" onclick="newListing()">List New Shoe</button>
            <button id="logout" onclick="firebase.auth().signOut(); location.reload()">Logout</button>
            <input class="form-control" id="shoeName" placeholder="Shoe Name" style="display: none">
            <input class="form-control" id="shoeSize" placeholder="Shoe Size" style="display: none">
            <input class="form-control" id="price" placeholder="Shoe Price" style="display: none">
            <input type="file" value="upload" id="filebutton" style="display: none">
            <input type="file" value="upload" id="filebutton2" style="display: none">
            <input type="file" value="upload" id="filebutton3" style="display: none">
            <input type="file" value="upload" id="filebutton4" style="display: none">
            <button id="postListing" onclick="writeNewPost()" style="display: none">Post</button>
        </div>

        <div class="fh5co-menu">
            <div class="fh5co-box">
                <h3 class="heading">Categories</h3>
                <ul>
                    <li><a href="#myListings.html">My Listings</a></li>
                    <li><a href="#">Style</a></li>
                    <li><a href="#">Photography</a></li>
                    <li><a href="#">Food &amp; Drinks</a></li>
                    <li><a href="#">Culture</a></li>
                </ul>
            </div>
            <div class="fh5co-box">
                <h3 class="heading">Search</h3>
                <form action="#">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Type a keyword">
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- END #fh5co-offcanvas -->
    <header id="fh5co-header">

        <div class="container-fluid">

            <div class="row">
                <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
                <div class="col-lg-12 col-md-12 text-center">
                    <h1 id="fh5co-logo"><a href="index.html">Crypto Kicks</a></h1>
                </div>

            </div>

        </div>

    </header>
    <!-- END #fh5co-header -->
    <div class="container-fluid" style="width:100%; height:100%;">
        <div id="html" class="row fh5co-post-entry" style="width:100%; height:100%;">
            <div class="clearfix visible-xs-block"></div>
        </div>
    </div>

    <footer id="fh5co-footer">
        <p><small>&copy; 2017. Crypto Kicks. All Rights Reserverd.</small></p>
    </footer>



    <!-- jQuery -->
    <script src="js/jquery.min.js"></script>
    <!-- jQuery Easing -->
    <script src="js/jquery.easing.1.3.js"></script>
    <!-- Bootstrap -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Waypoints -->
    <script src="js/jquery.waypoints.min.js"></script>
    <!-- Main JS -->
    <script src="js/main.js"></script>

</body>
<script>
    function writeNewPost() {
        price = document.getElementById("price").value;
        size = document.getElementById("shoeSize").value;
        name = document.getElementById("shoeName").value;
        username = firebase.auth().currentUser.displayName;
        uid = firebase.auth().currentUser.uid;

        var refList = [];

        var filebutton = document.getElementById('filebutton');
        var filebutton2 = document.getElementById('filebutton2');
        var filebutton3 = document.getElementById('filebutton3');
        var filebutton4 = document.getElementById('filebutton4');

        uid = firebase.auth().currentUser.uid;

        var storageRef = firebase.storage().ref();
        var file = filebutton.files[0];
        var metadata = {
            contentType: 'image/jpeg'
        };

        // Upload file and metadata to the object 'images/mountains.jpg'
        var uploadTask = storageRef.child('shoes/' + uid + '/' + file.name).put(file, metadata);
        let picCompleter = new $.Deferred();

        uploadTask.on('state_changed', null, error => {
            picCompleter.reject(error);
            console.error('Error while uploading new pic', error);
        }, () => {
            var url = uploadTask.snapshot.metadata.downloadURLs[0];
            console.log('File available at', url);
            picCompleter.resolve(url);
        });

        let picCompleter2 = new $.Deferred();

        var file2 = filebutton2.files[0];
        if (file2 != null) {
            var metadata = {
                contentType: 'image/jpeg'
            };

            // Upload file and metadata to the object 'images/mountains.jpg'
            var uploadTask2 = storageRef.child('shoes/' + uid + '/' + file2.name).put(file2, metadata);

            uploadTask2.on('state_changed', null, error => {
                picCompleter2.reject(error);
                console.error('Error while uploading new pic', error);
            }, () => {
                var url = uploadTask2.snapshot.metadata.downloadURLs[0];
                console.log('File available at', url);
                picCompleter2.resolve(url);
            });
        } else {
            picCompleter2.resolve("");
        }

        let picCompleter3 = new $.Deferred();

        var file3 = filebutton3.files[0];
        if (file3 != null) {
            var metadata = {
                contentType: 'image/jpeg'
            };

            // Upload file and metadata to the object 'images/mountains.jpg'
            var uploadTask3 = storageRef.child('shoes/' + uid + '/' + file3.name).put(file3, metadata);

            uploadTask3.on('state_changed', null, error => {
                picCompleter3.reject(error);
                console.error('Error while uploading new pic', error);
            }, () => {
                var url = uploadTask3.snapshot.metadata.downloadURLs[0];
                console.log('File available at', url);
                picCompleter3.resolve(url);
            });
        } else {
            picCompleter3.resolve("");
        }

        let picCompleter4 = new $.Deferred();

        var file4 = filebutton4.files[0];
        if (file4 != null) {
            var metadata = {
                contentType: 'image/jpeg'
            };

            // Upload file and metadata to the object 'images/mountains.jpg'
            var uploadTask4 = storageRef.child('shoes/' + uid + '/' + file4.name).put(file4, metadata);

            uploadTask4.on('state_changed', null, error => {
                picCompleter4.reject(error);
                console.error('Error while uploading new pic', error);
            }, () => {
                var url = uploadTask4.snapshot.metadata.downloadURLs[0];
                console.log('File available at', url);
                picCompleter4.resolve(url);
            });
        } else {
            picCompleter4.resolve("");
        }

        return Promise.all([picCompleter.promise(), picCompleter2.promise(), picCompleter3.promise(), picCompleter4.promise()]).then(urls => {
            // A post entry.
            var postData = {
                author: username,
                uid: uid,
                name: name,
                size: size,
                price: price,
                file1: urls[0],
                file2: urls[1],
                file3: urls[2],
                file4: urls[3]
            };

            // Get a key for a new Post.
            var newPostKey = firebase.database().ref().child('listings').push().key;

            // Write the new post's data simultaneously in the posts list and the user's post list.
            var updates = {};
            updates['/listings/' + newPostKey] = postData;
            updates['/user-listings/' + uid + '/' + newPostKey] = postData;

            document.getElementById("shoeName").style.display = "none";
            document.getElementById("shoeSize").style.display = "none";
            document.getElementById("price").style.display = "none";
            document.getElementById("postListing").style.display = "none";
            document.getElementById("filebutton").style.display = "none";
            document.getElementById("filebutton2").style.display = "none";
            document.getElementById("filebutton3").style.display = "none";
            document.getElementById("filebutton4").style.display = "none";
            localStorage.setItem("postKey", newPostKey);

            return firebase.database().ref().update(updates);
        });
    }

</script>
<script>
    function newListing() {
        document.getElementById("shoeName").style.display = "block";
        document.getElementById("shoeSize").style.display = "block";
        document.getElementById("price").style.display = "block";
        document.getElementById("postListing").style.display = "block";
        document.getElementById("filebutton").style.display = "block";
        document.getElementById("filebutton2").style.display = "block";
        document.getElementById("filebutton3").style.display = "block";
        document.getElementById("filebutton4").style.display = "block";
    }

</script>
<script>

    firebase.database().ref('listings').once('value').then(function(snapshot) {
        localStorage.setItem("listings", JSON.stringify(snapshot.val()));
    });

    firebase.database().ref('user-listings/' + firebase.auth().currentUser.uid).once('value').then(function(snapshot) {
        localStorage.setItem("user-listings", JSON.stringify(snapshot.val()));
    });

</script>
<script>
    var ref = firebase.database().ref().child('Listings');
    ref.on('value', snap => console.log(snap.val()));

</script>
<script>
    //    var user = firebase.auth().currentUser;
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            document.getElementById("username").innerHTML = user.displayName;
            document.getElementById("firebaseui-auth-container").style.display = "none";
            document.getElementById("logout").style.display = "block";
            document.getElementById("listingButton").style.display = "block";

        } else {
            document.getElementById("logout").style.display = "none";
            document.getElementById("firebaseui-auth-container").style.display = "block";
            document.getElementById("listingButton").style.display = "none";
        }
    });

</script>
<script>
    function showListing(listing, key) {
        var listingRef = firebase.storage().ref('listings/' + key);
        var userListingRef = firebase.storage().ref('user-listings/' + firebase.auth().currentUser.uid + "/" + key);

        baseHtml = document.createElement("Article");
        baseHtml.style.width = "25%";
        baseHtml.style.height = "350px";
        baseHtml.classList = "col-lg-3 col-md-3 col-sm-3 col-xs-6 col-xxs-12 animate-box";

        fig = document.createElement("div");
        fig.style.height = "100%";
        fig.style.width = "100%";
        aItem = document.createElement("a");
        aItem.style.maxHeight = "100%";
        aItem.style.maxWidth = "100%";

        aItem.classList.add("singleImg");
        image = document.createElement("img");
        image.classList.add("listing");
        image.classList.add("singleImg");
        image.src = listing["file1"];
        image.style.maxHeight = "100%";
        image.style.maxWidth = "100%";

        aItem.href = "single.html?listing=" + key;
        aItem.appendChild(image);
        aItem.addEventListener("click", function() {
            localStorage.setItem("currentItem", key);
            return true;
        });
        image.classList.add("img-responsive");
        fig.appendChild(aItem);
        baseHtml.appendChild(fig);

        shoeName = document.createTextNode(listing["name"]);
        shoeNameP = document.createElement("h3");
        shoeNameP.classList.add("col-xs-12");
        shoeNameP.appendChild(shoeName);
        fig.appendChild(shoeNameP);

        shoeSize = document.createTextNode("Size: " + listing["size"]);
        shoeSizeP = document.createElement("h4");
        shoeSizeP.classList.add("col-xs-6");
        shoeSizeP.appendChild(shoeSize);
        fig.appendChild(shoeSizeP);

        price = document.createTextNode("$" + listing["price"]);
        priceP = document.createElement("h4");
        priceP.classList.add("col-xs-6");
        priceP.appendChild(price);
        fig.appendChild(priceP);

        deleteButton = document.createElement("button");
        deleteButton.innerHTML = "delete listing";
        deleteButton.classList = "btn btn-danger";
        deleteButton.classList.add("col-xs-12");
        deleteButton.onclick = function() {
            var updates = {};
            updates['/listings/' + key] = null;
            updates['/user-listings/' + firebase.auth().currentUser.uid + '/' + key] = null;

            firebase.database().ref().update(updates);

            firebase.database().ref('listings').once('value').then(function(snapshot) {
                localStorage.setItem("listings", JSON.stringify(snapshot.val()));
            });

            firebase.database().ref('user-listings/' + firebase.auth().currentUser.uid).once('value').then(function(snapshot) {
                localStorage.setItem("user-listings", JSON.stringify(snapshot.val()));
            });
            
            alert("Listing successfully deleted!");
        };
        fig.appendChild(deleteButton);

        elem = document.getElementById("html");
        elem.appendChild(baseHtml);
    }

</script>
<script>
    listings = JSON.parse(localStorage.getItem("user-listings"));
    var listingsArray = [];
    for (var key in listings) {
        if (listings.hasOwnProperty(key)) {
            var oneListing = [listings[key], key];
            listingsArray.unshift(oneListing);
        }
    }
    for (var i = 0; i < listingsArray.length; i++) {
        showListing(listingsArray[i][0], listingsArray[i][1]);
    }
</script>

</html>
